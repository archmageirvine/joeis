package irvine.math.group;

import irvine.math.api.Field;
import irvine.math.api.Group;
import irvine.math.polynomial.Polynomial;
import irvine.math.z.Z;

/**
 * A Galois field.
 * @author Sean A. Irvine
 */
public class GaloisField extends IntegersMod implements Field<Z> {

  // WARNING: I'm not convinced this works entirely correctly, for p^k, k > 1.

  private final Z mCharacteristic;
  private final int mExponent;
  private final PolynomialRingField<Z> mBaseField;
  private final Polynomial<Z> mIrreducible;

  // These polynomials from SAGE:
  // for k in range(1, 50):
  //  print(str(GF(2^k).modulus().coefficients(sparse=False)))

  private static final long[][] IRR2 = {
    {1, 1},
    {1, 1, 1},
    {1, 1, 0, 1},
    {1, 1, 0, 0, 1},
    {1, 0, 1, 0, 0, 1},
    {1, 1, 0, 1, 1, 0, 1},
    {1, 1, 0, 0, 0, 0, 0, 1},
    {1, 0, 1, 1, 1, 0, 0, 0, 1},
    {1, 0, 0, 0, 1, 0, 0, 0, 0, 1},
    {1, 1, 1, 1, 0, 1, 1, 0, 0, 0, 1},
    {1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 1, 0, 1, 0, 1, 1, 1, 0, 0, 0, 0, 1},
    {1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1},
    {1, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 1, 0, 0, 1, 1, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 0, 0, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 0, 1, 0, 1, 0, 1, 0, 1, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 1, 0, 0, 1, 0, 1, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 1, 1, 0, 1, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 1, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 1, 1, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 0, 1, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 0, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 1, 0, 0, 1, 0, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 1, 0, 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 1, 1, 0, 0, 1, 0, 0, 1, 1, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 1, 0, 1, 0, 1, 0, 0, 1, 0, 0, 0, 1, 1, 0, 1, 1, 0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 1, 0, 1, 1, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 0, 1, 0, 0, 0, 1, 1, 0, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 1, 1, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
  };

  private static final long[][] IRR3 = {
    null, // 0 -- not used
    {2, 1},
    {2, 2, 1},
    {1, 2, 0, 1},
    {2, 0, 0, 2, 1},
    {1, 2, 0, 0, 0, 1},
    {2, 2, 1, 0, 2, 0, 1},
    {1, 0, 2, 0, 0, 0, 0, 1},
    {2, 2, 2, 0, 1, 2, 0, 0, 1},
    {1, 1, 2, 2, 0, 0, 0, 0, 0, 1},
    {2, 1, 0, 0, 2, 2, 2, 0, 0, 0, 1},
    {1, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 0, 1, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1},
    {1, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 0, 1, 2, 0, 1, 2, 1, 1, 2, 0, 0, 0, 0, 1},
    {1, 1, 2, 0, 0, 1, 0, 0, 2, 0, 0, 0, 0, 0, 0, 1},
    {2, 1, 2, 2, 2, 0, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 0, 2, 0, 2, 1, 2, 0, 2, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 1, 0, 2, 2, 2, 0, 0, 1, 1, 1, 1, 0, 2, 0, 0, 0, 0, 0, 0, 1},
    {1, 2, 0, 2, 0, 1, 2, 0, 2, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 2, 0, 1, 0, 1, 1, 1, 2, 2, 1, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 2, 0, 2, 2, 0, 2, 0, 2, 0, 0, 2, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 2, 1, 1, 0, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 1, 2, 1, 0, 0, 2, 2, 2, 2, 2, 2, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 0, 0, 1, 2, 0, 2, 0, 1, 1, 1, 2, 1, 1, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 2, 2, 1, 2, 2, 1, 2, 0, 2, 2, 2, 0, 2, 1, 0, 2, 2, 2, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 1, 0, 1, 2, 1, 2, 0, 0, 0, 0, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 2, 1, 2, 2, 1, 0, 0, 1, 0, 1, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 0, 0, 0, 2, 0, 2, 1, 0, 2, 0, 1, 2, 0, 2, 0, 2, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 1, 2, 0, 2, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 1, 1, 1, 0, 2, 2, 0, 2, 1, 2, 2, 0, 2, 2, 0, 1, 1, 0, 0, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 2, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 2, 0, 1, 2, 2, 2, 0, 2, 2, 1, 0, 2, 2, 2, 2, 1, 0, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 2, 0, 1, 0, 1, 2, 0, 1, 2, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 0, 1, 2, 1, 1, 2, 2, 1, 0, 1, 2, 0, 2, 0, 1, 1, 2, 0, 1, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 2, 0, 2, 0, 1, 0, 0, 2, 1, 0, 2, 1, 1, 2, 1, 2, 1, 1, 1, 0, 0, 2, 1, 0, 2, 2, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 0, 1, 1, 2, 2, 1, 1, 0, 0, 1, 0, 1, 0, 2, 2, 0, 1, 1, 0, 2, 1, 1, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 0, 0, 1, 1, 2, 0, 1, 2, 2, 0, 1, 2, 0, 1, 1, 2, 2, 2, 1, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 0, 1, 2, 2, 1, 0, 1, 0, 2, 1, 0, 0, 1, 2, 2, 0, 2, 0, 1, 1, 1, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 2, 2, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 0, 1, 2, 1, 0, 2, 0, 2, 0, 2, 2, 0, 2, 1, 0, 0, 1, 1, 1, 1, 2, 1, 0, 2, 0, 2, 2, 0, 1, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {1, 1, 0, 0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
  };

  private static final long[][] IRR5 = {
    null, // 0 -- not used
    {4, 1},
    {2, 4, 1},
    {3, 3, 0, 1},
    {2, 4, 4, 0, 1},
    {3, 4, 0, 0, 0, 1},
    {2, 0, 1, 4, 1, 0, 1},
    {3, 3, 0, 0, 0, 0, 0, 1},
    {2, 4, 3, 0, 1, 0, 0, 0, 1},
    {3, 1, 0, 2, 0, 0, 0, 0, 0, 1},
    {2, 1, 4, 2, 3, 3, 0, 0, 0, 0, 1},
    {3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 2, 3, 4, 4, 0, 1, 1, 0, 0, 0, 0, 1},
    {3, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 1, 0, 3, 2, 4, 4, 0, 1, 0, 0, 0, 0, 0, 1},
    {3, 4, 3, 3, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 1, 4, 4, 2, 4, 4, 4, 1, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 2, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 0, 2, 2, 0, 1, 2, 0, 2, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1},
    {3, 2, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 1, 0, 4, 0, 0, 3, 0, 2, 3, 4, 0, 3, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 2, 2, 1, 2, 2, 2, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 3, 3, 4, 0, 2, 2, 0, 3, 4, 0, 3, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 1, 3, 3, 2, 0, 4, 2, 4, 0, 3, 1, 2, 4, 0, 4, 2, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 4, 2, 4, 0, 1, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 3, 4, 3, 1, 1, 3, 3, 2, 1, 4, 0, 2, 2, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 3, 0, 4, 3, 2, 0, 3, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 4, 2, 3, 0, 2, 0, 2, 3, 2, 4, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 1, 3, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 1, 1, 0, 1, 4, 3, 4, 2, 2, 0, 2, 3, 4, 4, 0, 4, 4, 0, 3, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 0, 2, 3, 3, 1, 4, 1, 4, 1, 0, 3, 3, 3, 3, 4, 2, 0, 1, 4, 2, 3, 3, 1, 4, 2, 4, 4, 2, 4, 4, 1, 1},
    {3, 0, 1, 3, 3, 0, 3, 2, 4, 1, 3, 1, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 0, 0, 2, 3, 1, 0, 4, 3, 1, 4, 1, 2, 3, 4, 2, 2, 1, 1, 1, 4, 4, 3, 4, 1, 1, 0, 1, 1, 4, 3, 3, 1, 0, 1},
    {3, 2, 0, 2, 1, 3, 2, 0, 0, 4, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 1, 3, 1, 0, 4, 0, 2, 2, 0, 3, 0, 4, 1, 2, 3, 3, 1, 0, 2, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 3, 2, 4, 4, 4, 1, 1, 4, 3, 1, 4, 1, 2, 2, 1, 4, 2, 4, 1, 2, 2, 0, 2, 0, 2, 3, 0, 0, 1, 1, 1, 1, 4, 2, 2, 1, 1, 1},
    {3, 2, 1, 0, 2, 3, 0, 4, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 2, 0, 1, 1, 3, 4, 0, 3, 1, 0, 1, 2, 2, 1, 0, 3, 0, 1, 0, 2, 1, 3, 2, 2, 4, 4, 3, 4, 4, 2, 3, 2, 0, 1, 2, 3, 0, 0, 4, 1},
    {3, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 1, 2, 0, 2, 3, 3, 0, 1, 4, 2, 4, 2, 4, 2, 3, 3, 0, 0, 3, 0, 1, 0, 3, 3, 4, 0, 4, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 1, 3, 3, 3, 2, 0, 0, 2, 0, 1, 0, 1, 4, 0, 4, 1, 0, 3, 3, 3, 2, 3, 2, 0, 0, 1, 1, 0, 2, 2, 4, 4, 1, 1, 0, 0, 4, 3, 4, 3, 0, 2, 1, 1},
    {3, 0, 0, 1, 3, 3, 3, 0, 1, 3, 3, 0, 1, 3, 1, 2, 2, 0, 2, 3, 1, 0, 0, 0, 3, 1, 3, 0, 2, 3, 1, 1, 1, 3, 4, 1, 0, 4, 1, 2, 4, 2, 2, 3, 2, 1},
    {2, 3, 0, 3, 3, 0, 4, 1, 2, 4, 3, 4, 3, 0, 4, 4, 2, 2, 0, 1, 1, 1, 2, 1, 1, 2, 0, 3, 3, 0, 1, 0, 4, 3, 4, 2, 3, 1, 2, 4, 1, 3, 0, 4, 4, 0, 1},
    {3, 0, 4, 1, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {2, 4, 4, 2, 0, 0, 0, 2, 1, 0, 2, 3, 1, 2, 3, 4, 3, 2, 2, 0, 2, 0, 2, 0, 0, 3, 2, 3, 0, 1, 4, 4, 3, 4, 2, 1, 2, 4, 0, 4, 1, 1, 3, 2, 4, 1, 4, 2, 1},
    {3, 2, 2, 4, 0, 1, 0, 1, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
  };

  private static final long[][] IRR7 = {
    null, // 0 -- not used
    {6, 1},
    {3, 6, 1},
    {4, 0, 6, 1},
    {3, 4, 5, 0, 1},
    {4, 1, 0, 0, 0, 1},
    {3, 6, 4, 5, 1, 0, 1},
    {4, 6, 0, 0, 0, 0, 0, 1},
    {3, 2, 6, 4, 0, 0, 0, 0, 1},
    {4, 6, 0, 1, 6, 0, 0, 0, 0, 1},
    {3, 3, 2, 1, 4, 1, 1, 0, 0, 0, 1},
    {4, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 0, 5, 0, 4, 2, 3, 5, 2, 0, 0, 0, 1},
    {4, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 6, 3, 0, 2, 6, 0, 5, 0, 0, 0, 0, 0, 0, 1},
    {4, 2, 1, 4, 6, 6, 5, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 4, 2, 6, 1, 4, 3, 5, 4, 0, 0, 0, 0, 0, 0, 0, 1},
    {4, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 2, 6, 0, 0, 3, 1, 5, 6, 1, 6, 2, 1, 0, 0, 0, 0, 0, 1},
    {4, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 1, 0, 3, 0, 3, 1, 3, 2, 5, 2, 6, 1, 0, 0, 0, 0, 0, 0, 0, 1},
    {4, 4, 0, 6, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 4, 5, 5, 6, 4, 3, 2, 5, 3, 5, 6, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 3, 4, 6, 2, 2, 5, 4, 3, 0, 1, 2, 1, 5, 5, 6, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {4, 2, 1, 0, 5, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 5, 5, 0, 2, 0, 1, 4, 6, 1, 6, 3, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {4, 0, 5, 5, 4, 2, 6, 4, 5, 1, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 1, 0, 5, 1, 3, 6, 4, 2, 2, 6, 2, 6, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {4, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 2, 5, 1, 0, 3, 2, 4, 2, 3, 3, 2, 5, 6, 3, 2, 1, 0, 4, 1, 4, 4, 1, 0, 0, 0, 0, 0, 0, 0, 1},
    {4, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 0, 2, 4, 0, 1, 1, 5, 1, 4, 5, 1, 5, 2, 0, 6, 6, 6, 1, 6, 4, 1, 3, 3, 4, 0, 6, 0, 0, 1, 2, 5, 1},
    {4, 6, 0, 3, 5, 5, 6, 5, 6, 4, 6, 6, 2, 6, 6, 3, 0, 0, 6, 5, 5, 6, 5, 2, 2, 5, 3, 1, 0, 3, 5, 2, 0, 1},
    {3, 1, 1, 4, 2, 6, 1, 2, 6, 5, 4, 6, 3, 4, 3, 0, 1, 5, 4, 2, 1, 2, 0, 0, 3, 5, 5, 6, 3, 2, 4, 3, 0, 2, 1},
    {4, 4, 0, 3, 1, 3, 5, 5, 6, 5, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 1, 1, 3, 3, 6, 0, 6, 3, 3, 6, 2, 3, 3, 0, 4, 1, 6, 6, 2, 2, 5, 4, 3, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {4, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 3, 0, 4, 3, 6, 2, 2, 0, 0, 3, 2, 0, 1, 0, 1, 0, 3, 2, 2, 5, 2, 0, 2, 4, 4, 2, 6, 1, 3, 3, 6, 1, 6, 4, 3, 6, 1, 1},
    {4, 3, 5, 3, 3, 3, 4, 0, 5, 5, 6, 4, 1, 6, 0, 4, 1, 4, 4, 2, 2, 4, 1, 5, 1, 2, 2, 2, 4, 4, 2, 0, 4, 4, 1, 6, 0, 4, 6, 1},
    {3, 2, 3, 4, 6, 2, 0, 2, 3, 1, 6, 4, 0, 1, 4, 2, 5, 2, 3, 1, 5, 6, 0, 4, 4, 2, 1, 3, 3, 6, 6, 2, 6, 3, 5, 0, 3, 2, 0, 0, 1},
    {4, 1, 4, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 5, 2, 3, 0, 1, 0, 3, 1, 6, 0, 5, 1, 0, 2, 5, 2, 4, 3, 2, 6, 6, 2, 4, 1, 5, 0, 6, 1, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {4, 2, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 0, 6, 1, 1, 6, 1, 3, 1, 6, 2, 2, 3, 5, 2, 3, 1, 0, 1, 0, 4, 6, 1, 0, 2, 5, 1, 6, 1, 2, 2, 2, 3, 2, 2, 0, 3, 4, 1, 3, 0, 6, 5, 0, 1},
    {4, 3, 1, 3, 1, 0, 0, 2, 0, 5, 2, 6, 3, 3, 1, 6, 6, 6, 1, 2, 5, 6, 4, 2, 4, 5, 3, 6, 1, 2, 5, 3, 5, 3, 1, 5, 0, 0, 5, 6, 4, 4, 5, 1, 3, 1},
    {3, 6, 1, 6, 4, 4, 4, 2, 4, 1, 6, 3, 6, 0, 3, 3, 2, 6, 0, 4, 0, 3, 5, 2, 2, 1, 2, 6, 5, 1, 5, 6, 5, 0, 5, 0, 3, 3, 3, 2, 0, 6, 0, 1, 1, 3, 1},
    {4, 3, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
    {3, 0, 1, 3, 5, 2, 6, 2, 4, 6, 3, 5, 5, 5, 5, 4, 6, 4, 0, 6, 6, 0, 1, 1, 2, 2, 1, 1, 0, 1, 0, 6, 0, 4, 4, 5, 4, 1, 1, 6, 4, 1, 6, 5, 1, 2, 1, 1, 1},
    {4, 1, 2, 1, 5, 4, 3, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1},
  };

  /**
   * Construct the Galois field <code>GF(p^k)</code>.
   * @param p prime base
   * @param k order
   */
  public GaloisField(final Z p, final int k) {
    super(p.pow(k));
    if (!p.isPrime()) {
      throw new IllegalArgumentException();
    }
    mCharacteristic = p;
    mExponent = k;
    if (k > 1) {
      mBaseField = new PolynomialRingField<>(new GaloisField(p));
      if (Z.TWO.equals(p)) {
        mIrreducible = Polynomial.create(IRR2[k]);
      } else if (Z.THREE.equals(p)) {
        mIrreducible = Polynomial.create(IRR3[k]);
      } else if (Z.FIVE.equals(p)) {
        mIrreducible = Polynomial.create(IRR5[k]);
      } else if (Z.SEVEN.equals(p)) {
        mIrreducible = Polynomial.create(IRR7[k]);
      } else {
        mIrreducible = null;
      }
    } else {
      mBaseField = null;
      mIrreducible = null;
    }
  }

  /**
   * Construct the Galois field <code>GF(p)</code>.
   * @param p prime base
   */
  public GaloisField(final Z p) {
    this(p, 1);
  }

  /**
   * Construct the Galois field <code>GF(p)</code>.
   * @param p prime base
   */
  public GaloisField(final long p) {
    this(Z.valueOf(p), 1);
  }

  @Override
  public Z inverse(final Z element) {
    if (mExponent == 1) {
      return element.modInverse(size());
    }
    if (mIrreducible != null) {
      return pack(mBaseField.mod(mBaseField.inverse(unpack(mBaseField, element)), mIrreducible));
    }
    throw new UnsupportedOperationException("Please update GaloisField with irreducible polynomial for " + this);
  }

  @Override
  public Z divide(final Z n, final Z d) {
    return n.modMultiply(inverse(d), size());
  }

  @Override
  public Group<Z> multiplicativeGroup() {
    return new MultiplicativeGroup<>(this);
  }

  @Override
  public Z characteristic() {
    return mCharacteristic;
  }

  private Polynomial<Z> unpack(final PolynomialRing<Z> ring, final Z n) {
    // Convert n to a polynomial representation in base p
    final Polynomial<Z> a = ring.empty();
    Z m = n;
    while (!m.isZero()) {
      final Z[] qr = m.divideAndRemainder(mCharacteristic);
      a.add(qr[1]);
      m = qr[0];
    }
    return a;
  }

  private Z pack(final Polynomial<Z> p) {
    // Convert a polynomial to an integer in base mCharacteristic
    Z res = Z.ZERO;
    for (int k = p.degree(); k >= 0; --k) {
      res = res.multiply(mCharacteristic).add(p.coeff(k));
    }
    return res;
  }

  @Override
  public Z multiply(final Z a, final Z b) {
    if (mExponent == 1) {
      return super.multiply(a, b);
    }
    if (mIrreducible != null) {
      return pack(mBaseField.mod(mBaseField.multiply(unpack(mBaseField, a), unpack(mBaseField, b)), mIrreducible));
    }
    throw new UnsupportedOperationException("Please update GaloisField with irreducible polynomial for " + this);
  }

  @Override
  public Z add(final Z a, final Z b) {
    if (mExponent == 1) {
      return super.add(a, b);
    }
    if (mIrreducible != null) {
      return pack(mBaseField.mod(mBaseField.add(unpack(mBaseField, a), unpack(mBaseField, b)), mIrreducible)).mod(size());
    }
    throw new UnsupportedOperationException("Please update GaloisField with irreducible polynomial for " + this);
  }

  /**
   * The characteristic polynomial of a ring element.
   * @param n element
   * @return characteristic polynomial
   */
  public Polynomial<Z> characteristicPolynomial(final Z n) {
    if (mExponent <= 1) {
      return Polynomial.create(mCharacteristic.subtract(n).mod(mCharacteristic), Z.ONE); // x - n
    }
    Polynomial<Z> cp = mBaseField.one();
    for (int k = 0; k < mExponent; ++k) {
      final Z t = AbstractRing.pow(this, n, mCharacteristic.pow(k).longValueExact());
      cp = mBaseField.mod(mBaseField.multiply(cp, mBaseField.subtract(mBaseField.x(), unpack(mBaseField, t))), mIrreducible);
    }
    // This last addition for consistency with Sage and Magma
    return mBaseField.add(cp, mIrreducible);
  }
}
